@page "/db-test"
@using Microsoft.EntityFrameworkCore
@implements IAsyncDisposable

<PageTitle>Database Test</PageTitle>

<h1>Database Test</h1>

@if (error != null)
{
    <div style="color: red; padding: 10px; border: 2px solid red; margin: 10px 0;">
        <strong>❌ Error:</strong>
        <pre>@error</pre>
    </div>
}

@if (status != null)
{
    <div style="color: blue; padding: 10px; border: 2px solid blue; margin: 10px 0;">
        <strong>ℹ️ Status:</strong>
        <p>@status</p>
    </div>
}

@if (success)
{
    <div style="color: green; padding: 10px; border: 2px solid green; margin: 10px 0;">
        <strong>✅ Success!</strong>
        <p>Database initialized and test data created.</p>
    </div>
}

<h2>Categories</h2>
@if (categories != null && categories.Any())
{
    <table style="border-collapse: collapse; width: 100%; margin: 10px 0;">
        <thead>
            <tr style="background: #f0f0f0;">
                <th style="border: 1px solid #ccc; padding: 8px;">ID</th>
                <th style="border: 1px solid #ccc; padding: 8px;">Name</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var category in categories)
            {
                <tr>
                    <td style="border: 1px solid #ccc; padding: 8px;">@category.Id</td>
                    <td style="border: 1px solid #ccc; padding: 8px;">@category.Name</td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <p>No categories found.</p>
}

<h2>Allocations</h2>
@if (allocations != null && allocations.Any())
{
    <table style="border-collapse: collapse; width: 100%; margin: 10px 0;">
        <thead>
            <tr style="background: #f0f0f0;">
                <th style="border: 1px solid #ccc; padding: 8px;">ID</th>
                <th style="border: 1px solid #ccc; padding: 8px;">Name</th>
                <th style="border: 1px solid #ccc; padding: 8px;">Category</th>
                <th style="border: 1px solid #ccc; padding: 8px;">Type</th>
                <th style="border: 1px solid #ccc; padding: 8px;">Amount</th>
                <th style="border: 1px solid #ccc; padding: 8px;">Frequency</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var allocation in allocations)
            {
                <tr>
                    <td style="border: 1px solid #ccc; padding: 8px;">@allocation.Id</td>
                    <td style="border: 1px solid #ccc; padding: 8px;">@allocation.Name</td>
                    <td style="border: 1px solid #ccc; padding: 8px;">@(allocation.Category?.Name ?? "N/A")</td>
                    <td style="border: 1px solid #ccc; padding: 8px;">@allocation.Type</td>
                    <td style="border: 1px solid #ccc; padding: 8px;">$@allocation.Amount</td>
                    <td style="border: 1px solid #ccc; padding: 8px;">@allocation.Frequency</td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <p>No allocations found.</p>
}

<button @onclick="RefreshData" style="padding: 10px 20px; margin: 10px 0;">Refresh Data</button>

@code {
    private BudgetContext? context;
    private List<Category>? categories;
    private List<Allocation>? allocations;
    private string? error;
    private string? status;
    private bool success;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            status = "Initializing database...";
            StateHasChanged();

            context = new BudgetContext();
            
            status = "Ensuring database is created...";
            StateHasChanged();
            await context.Database.EnsureCreatedAsync();

            status = "Checking for existing data...";
            StateHasChanged();
            
            var existingCategories = await context.Categories.CountAsync();
            if (existingCategories == 0)
            {
                status = "Creating test categories...";
                StateHasChanged();

                var housingCategory = new Category { Name = "Housing" };
                var savingsCategory = new Category { Name = "Retirement Savings" };
                
                context.Categories.AddRange(housingCategory, savingsCategory);
                await context.SaveChangesAsync();

                status = "Creating test allocations...";
                StateHasChanged();

                var allocations = new[]
                {
                    new Allocation 
                    { 
                        Name = "Rent", 
                        Category = housingCategory,
                        Type = Allocation.AllocationType.Expense,
                        Amount = 1500.00m,
                        Frequency = Allocation.AllocationFrequency.Monthly
                    },
                    new Allocation 
                    { 
                        Name = "Renter's Insurance", 
                        Category = housingCategory,
                        Type = Allocation.AllocationType.Expense,
                        Amount = 25.00m,
                        Frequency = Allocation.AllocationFrequency.Monthly
                    },
                    new Allocation 
                    { 
                        Name = "Roth IRA", 
                        Category = savingsCategory,
                        Type = Allocation.AllocationType.Savings,
                        Amount = 500.00m,
                        Frequency = Allocation.AllocationFrequency.Monthly
                    }
                };

                context.Allocations.AddRange(allocations);
                await context.SaveChangesAsync();
            }

            await RefreshData();
            success = true;
            status = null;
        }
        catch (Exception ex)
        {
            error = ex.ToString();
            status = null;
        }
    }

    private async Task RefreshData()
    {
        if (context == null) return;

        try
        {
            categories = await context.Categories.ToListAsync();
            allocations = await context.Allocations.Include(a => a.Category).ToListAsync();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            error = ex.ToString();
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (context != null)
        {
            await context.DisposeAsync();
        }
    }
}
