@page "/client-proof"
@using Microsoft.Data.Sqlite
@using Microsoft.EntityFrameworkCore
@inject IJSRuntime JS
@implements IAsyncDisposable

<PageTitle>Client-Side Proof</PageTitle>

<h1>üîç Client-Side SQLite Proof</h1>

<div style="background: #f0f0f0; padding: 15px; margin: 10px 0; border-radius: 5px;">
    <h3>Why this proves it's client-side:</h3>
    <ol>
        <li><strong>Blazor WebAssembly runs entirely in the browser</strong> - There is NO server backend in this app</li>
        <li><strong>Check the Network tab</strong> in your browser DevTools - you'll see NO database API calls</li>
        <li><strong>Works offline</strong> - Disconnect from internet and it still works</li>
        <li><strong>Database file location</strong> shows it's in browser storage (IndexedDB)</li>
    </ol>
</div>

<h2>üåê Runtime Environment</h2>
<div style="border: 2px solid #4CAF50; padding: 10px; margin: 10px 0;">
    <p><strong>Platform:</strong> @platform</p>
    <p><strong>Is Browser:</strong> @isBrowser</p>
    <p><strong>Database Location:</strong> <code>@dbLocation</code></p>
</div>

<h2>üìä Live Database Operations</h2>
<button @onclick="PerformOperations" style="padding: 10px 20px; margin: 10px 0; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
    Run Client-Side Operations
</button>

@if (operations.Any())
{
    <div style="background: #fff; border: 1px solid #ddd; padding: 10px; margin: 10px 0;">
        @foreach (var op in operations)
        {
            <div style="padding: 5px; border-bottom: 1px solid #eee;">
                <strong>[@op.Timestamp]</strong> @op.Message
            </div>
        }
    </div>
}

<h2>üîå Network Activity Monitor</h2>
<div style="background: #fff3cd; border: 2px solid #ffc107; padding: 15px; margin: 10px 0;">
    <p><strong>Instructions to verify NO server calls:</strong></p>
    <ol>
        <li>Open DevTools (F12)</li>
        <li>Go to Network tab</li>
        <li>Click "Run Client-Side Operations" button above</li>
        <li>Watch the Network tab - you'll see ZERO API/database requests</li>
        <li>All SQLite operations happen in your browser's memory/IndexedDB</li>
    </ol>
</div>

<h2>üíæ Current Database Content</h2>
@if (categories != null)
{
    <h3>Categories (@categories.Count)</h3>
    <ul>
        @foreach (var cat in categories)
        {
            <li>ID: @cat.Id, Name: @cat.Name</li>
        }
    </ul>
}

@if (allocations != null)
{
    <h3>Allocations (@allocations.Count)</h3>
    <ul>
        @foreach (var alloc in allocations)
        {
            <li>@alloc.Name - $@alloc.Amount (@alloc.Frequency)</li>
        }
    </ul>
}

<h2>üß™ SQLite Version & Info</h2>
@if (!string.IsNullOrEmpty(sqliteVersion))
{
    <div style="background: #e7f3ff; border: 2px solid #2196F3; padding: 10px; margin: 10px 0;">
        <p><strong>SQLite Version:</strong> @sqliteVersion</p>
        <p><strong>Compiled Options:</strong></p>
        <pre style="background: #f5f5f5; padding: 10px; overflow-x: auto;">@compileOptions</pre>
    </div>
}

@code {
    private BudgetContext? context;
    private List<Category>? categories;
    private List<Allocation>? allocations;
    private List<OperationLog> operations = new();
    private string platform = "";
    private string isBrowser = "";
    private string dbLocation = "In-memory WASM/IndexedDB";
    private string sqliteVersion = "";
    private string compileOptions = "";

    class OperationLog
    {
        public string Timestamp { get; set; } = DateTime.Now.ToString("HH:mm:ss.fff");
        public string Message { get; set; } = "";
    }

    protected override async Task OnInitializedAsync()
    {
        // Get runtime info
        platform = System.Runtime.InteropServices.RuntimeInformation.OSDescription;
        isBrowser = OperatingSystem.IsBrowser().ToString();

        // Get SQLite info
        try
        {
            using var conn = new SqliteConnection("Data Source=:memory:");
            await conn.OpenAsync();
            
            using var cmd = conn.CreateCommand();
            cmd.CommandText = "SELECT sqlite_version()";
            sqliteVersion = (await cmd.ExecuteScalarAsync())?.ToString() ?? "Unknown";

            cmd.CommandText = "PRAGMA compile_options";
            using var reader = await cmd.ExecuteReaderAsync();
            var options = new List<string>();
            while (await reader.ReadAsync())
            {
                options.Add(reader.GetString(0));
            }
            compileOptions = string.Join("\n", options);
        }
        catch (Exception ex)
        {
            sqliteVersion = $"Error: {ex.Message}";
        }

        // Initialize context
        context = new BudgetContext();
        await context.Database.EnsureCreatedAsync();
        await LoadData();
    }

    private async Task PerformOperations()
    {
        if (context == null) return;

        operations.Clear();
        
        try
        {
            LogOperation("üî∑ Starting client-side SQLite operations...");
            
            LogOperation("üìù Creating new category 'Test Category'...");
            var testCat = new Category { Name = $"Test Category {DateTime.Now:HHmmss}" };
            context.Categories.Add(testCat);
            await context.SaveChangesAsync();
            LogOperation($"‚úÖ Category created with ID: {testCat.Id}");

            LogOperation("üìù Creating new allocation...");
            var testAlloc = new Allocation
            {
                Name = $"Test Item {DateTime.Now:HHmmss}",
                Category = testCat,
                Type = Allocation.AllocationType.Expense,
                Amount = new Random().Next(10, 500),
                Frequency = Allocation.AllocationFrequency.Monthly
            };
            context.Allocations.Add(testAlloc);
            await context.SaveChangesAsync();
            LogOperation($"‚úÖ Allocation created with ID: {testAlloc.Id}");

            LogOperation("üîç Querying database...");
            var count = await context.Categories.CountAsync();
            LogOperation($"üìä Total categories in database: {count}");

            LogOperation("üîÑ Refreshing display...");
            await LoadData();
            
            LogOperation("‚ú® All operations completed successfully!");
            LogOperation("üëÄ Check Network tab - NO server requests were made!");
        }
        catch (Exception ex)
        {
            LogOperation($"‚ùå Error: {ex.Message}");
        }

        StateHasChanged();
    }

    private async Task LoadData()
    {
        if (context == null) return;
        
        categories = await context.Categories.ToListAsync();
        allocations = await context.Allocations.Include(a => a.Category).ToListAsync();
    }

    private void LogOperation(string message)
    {
        operations.Add(new OperationLog { Message = message });
    }

    public async ValueTask DisposeAsync()
    {
        if (context != null)
        {
            await context.DisposeAsync();
        }
    }
}
